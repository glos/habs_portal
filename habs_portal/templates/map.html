{% extends "base.html" %}
{% block title %}
    <title>HABS Data Portal</title>
{% endblock %}
{% block head %}
<!-- Unfortunately leaflet and Grunt don't get along -->
<link href="/lib/leaflet/dist/leaflet.css" rel="stylesheet" type="text/css">
<script src="/lib/leaflet/dist/leaflet.js" type="text/javascript"></script>

<!-- Partials -->
<script src="/js/partials/compiled/map.js" type="text/javascript"></script>

<!-- Scripts -->
<script src="/js/compiled/map.js" type="text/javascript"></script>

<!-- CSS -->
<link href="/css/compiled/map.css" rel="stylesheet" type="text/css">
{% endblock %}
{% block body %}

<div id="banner">
</div>
<div id="navbar">
</div>
<div id="wrapper">
  <div id="sidebar-wrapper">
  </div>
  <div id="page-content-wrapper">
    <div id="map-view">
    </div> <!-- #map -->
  </div> <!-- #page-content-wrapper -->
</div> <!-- #wrapper -->

<script type="text/javascript">
var App = function() {
}

_.extend(App.prototype, Backbone.Events, {
  views: {
    bannerVeiw: null,
    navbarView: null,
    mapView: null,
    tocView: null
  },
  models: {
  },
  collections: {
    stations: null,
    activeStations: null,
  },
  start: function() {
    var self = this;

    /* Collections */
    this.collections.stations = new StationCollection();
    this.collections.activeStations = new StationCollection();
    this.collections.categories = new CategoryCollection();

    /* Views */
    this.views.bannerView = new BannerView({
      el: $('#banner')
    }).render();
    this.views.navbarView = new NavbarView({
      el: $('#navbar'),
      mode: 'map'
    }).render();
    this.views.mapView = new StationMapView({
      el: $('#map-view'),
      collection: this.collections.activeStations,
      center: [44.71, -83.15],
      zoom: 7
    }).render();
    // this.views.mapView = new MapView();
    // this.views.tocView = new TOCView();

    this.listenTo(this.collections.stations, 'reset', function(collection) {
      var models = collection.models;
      self.collections.activeStations.reset(models);
    });

    this.listenTo(this.collections.activeStations, 'reset', function(collection) {
      self.views.mapView.drawStations();
    });

    this.listenTo(this.views.mapView, 'stationClick', function(feature) {
      console.log("I clicked a feature");
      console.log(feature.circle);
      this.views.mapView.selectStation(feature.model);
    });

    this.listenTo(this.views.mapView, 'mapClick', function() {
      this.views.mapView.clearSelection();
    });


    /* Fetching */
    this.collections.stations.fetch({reset: true});
    this.collections.categories.fetch({reset: true});
  }
});

app = new App();
$(document).ready(function() {
  app.start();
});

</script>
{% endblock %}

